<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Conexión API CityVibes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #4a89dc;
            text-align: center;
        }
        
        h2 {
            color: #555;
            margin-top: 20px;
        }
        
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .endpoint-list {
            list-style-type: none;
            padding: 0;
        }
        
        .endpoint-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f1f1f1;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        
        .endpoint-item:hover {
            background-color: #e9e9e9;
        }
        
        .method {
            font-weight: bold;
            display: inline-block;
            width: 60px;
        }
        
        .method.get {
            color: #28a745;
        }
        
        .method.post {
            color: #007bff;
        }
        
        .method.put {
            color: #fd7e14;
        }
        
        .method.delete {
            color: #dc3545;
        }
        
        button {
            background-color: #4a89dc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #3872c0;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .success {
            color: green;
        }
        
        .error {
            color: red;
        }
        
        .warning {
            color: orange;
        }
        
        .login-form {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test de Conexión API CityVibes</h1>
        
        <div class="login-form">
            <h2>Login</h2>
            <div class="form-group">
                <label for="username">Username o Email:</label>
                <input type="text" id="username" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" placeholder="contraseña">
            </div>
            <button id="loginBtn">Iniciar Sesión</button>
        </div>
        
        <h2>Endpoints Disponibles</h2>
        <ul class="endpoint-list">
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users">
                <span><span class="method get">GET</span> /api/Users</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="PUT" data-endpoint="/api/users">
                <span><span class="method put">PUT</span> /api/users</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="DELETE" data-endpoint="/api/users/Delete">
                <span><span class="method delete">DELETE</span> /api/users/Delete</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users/OrderDesc">
                <span><span class="method get">GET</span> /api/Users/OrderDesc</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users/Usernames">
                <span><span class="method get">GET</span> /api/Users/Usernames</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users/Emails">
                <span><span class="method get">GET</span> /api/Users/Emails</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users/Availables">
                <span><span class="method get">GET</span> /api/Users/Availables</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="POST" data-endpoint="/api/Users/Register">
                <span><span class="method post">POST</span> /api/Users/Register</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="POST" data-endpoint="/api/Users/Unable">
                <span><span class="method post">POST</span> /api/Users/Unable</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="POST" data-endpoint="/api/Users/Login">
                <span><span class="method post">POST</span> /api/Users/Login</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="GET" data-endpoint="/api/Users/{id}">
                <span><span class="method get">GET</span> /api/Users/{id}</span>
                <button class="test-btn">Probar</button>
            </li>
            <li class="endpoint-item" data-method="POST" data-endpoint="/api/Users">
                <span><span class="method post">POST</span> /api/Users</span>
                <button class="test-btn">Probar</button>
            </li>
        </ul>
        
        <h2>Resultados</h2>
        <div id="results">
            <div class="log-entry">Selecciona un endpoint para probar la conexión...</div>
        </div>
    </div>
    
    <script>
        // Variable global para la URL de la API
        const API_URL = 'https://cityvibess.bsite.net';
        let authToken = localStorage.getItem('authToken');
        
        // Función para mostrar mensajes en el área de resultados
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            resultsDiv.appendChild(logEntry);
            
            // Auto-scroll al final
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Función para probar un endpoint específico
        async function testEndpoint(method, endpoint) {
            log(`Probando ${method} ${endpoint}`);
            
            try {
                // Preparar opciones para fetch
                const options = {
                    method: method,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                };
                
                // Agregar token de autenticación si está disponible
                if (authToken) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                    log('Usando token de autenticación', 'info');
                } else {
                    log('No hay token de autenticación disponible', 'warning');
                }
                
                // Para endpoints específicos, agregamos un cuerpo
                if (endpoint === '/api/Users/Login') {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        log('Por favor ingresa username/email y contraseña para login', 'error');
                        return;
                    }
                    
                    options.body = JSON.stringify({
                        username: username,
                        password: password
                    });
                    
                    log(`Intentando login con usuario: ${username}`);
                } else if (method !== 'GET' && method !== 'DELETE') {
                    // Para otros métodos POST/PUT, agregamos un cuerpo genérico
                    options.body = JSON.stringify({
                        // Datos genéricos para prueba
                    });
                }
                
                // Si el endpoint contiene {id}, reemplazar con un ID de prueba
                let url = endpoint;
                if (url.includes('{id}')) {
                    url = url.replace('{id}', '1'); // ID de prueba
                    log('Reemplazando {id} con 1 para la prueba');
                }
                
                // Realizar la petición
                const response = await fetch(`${API_URL}${url}`, options);
                
                // Procesar la respuesta
                if (response.ok) {
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            log(`✅ Conexión exitosa (${response.status})`, 'success');
                            
                            // Si es un login exitoso, guardar el token
                            if (endpoint === '/api/Users/Login' && data.token) {
                                authToken = data.token;
                                localStorage.setItem('authToken', authToken);
                                log('✅ Login exitoso! Token guardado.', 'success');
                            }
                            
                            // Mostrar los datos recibidos
                            log(`Respuesta: ${JSON.stringify(data, null, 2)}`);
                        } else {
                            const text = await response.text();
                            log(`✅ Conexión exitosa (${response.status})`, 'success');
                            log(`Respuesta: ${text}`);
                        }
                    } catch (error) {
                        log(`✅ Conexión exitosa pero error al procesar respuesta: ${error.message}`, 'warning');
                    }
                } else {
                    try {
                        const errorData = await response.json();
                        log(`❌ Error en la respuesta: ${response.status} ${response.statusText}`, 'error');
                        log(`Detalle: ${JSON.stringify(errorData)}`);
                    } catch (e) {
                        log(`❌ Error en la respuesta: ${response.status} ${response.statusText}`, 'error');
                    }
                }
            } catch (error) {
                log(`❌ Error general: ${error.message}`, 'error');
            }
        }
        
        // Configurar eventos para los botones de prueba
        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', () => {
                const listItem = button.parentElement;
                const method = listItem.getAttribute('data-method');
                const endpoint = listItem.getAttribute('data-endpoint');
                
                // Limpiar resultados anteriores si hay muchos
                const resultsDiv = document.getElementById('results');
                if (resultsDiv.children.length > 20) {
                    resultsDiv.innerHTML = '';
                }
                
                testEndpoint(method, endpoint);
            });
        });
        
        // Configurar evento para el botón de login
        document.getElementById('loginBtn').addEventListener('click', () => {
            // Encontrar el endpoint de login y simular un clic en su botón de prueba
            const loginItem = document.querySelector('.endpoint-item[data-endpoint="/api/Users/Login"]');
            if (loginItem) {
                loginItem.querySelector('.test-btn').click();
            } else {
                log('No se encontró el endpoint de login', 'error');
            }
        });
        
        // Mostrar estado de autenticación al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                log('🔑 Hay un token de autenticación guardado', 'success');
            } else {
                log('No hay token de autenticación. Usa el formulario de login para obtener uno.', 'info');
            }
            
            log('Selecciona un endpoint para probarlo o usa el formulario de login.');
        });
    </script>
</body>
</html>